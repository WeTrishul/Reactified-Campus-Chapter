
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
   

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
   
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="index.css">

    <style>
        @import url(https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.min.css);
        .active\:bg-gray-50:active {
            --tw-bg-opacity:1;
            background-color: rgba(249,250,251,var(--tw-bg-opacity));
        }
       
        </style>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
</head>
<body class="bg-gray" >
    



<%- include('_navbar') -%>



<!-- ################################################################  ---------- ############################################################-->
<!-- ################################################################  Navbar Ends ############################################################-->
<!-- ################################################################  ----------- ############################################################-->


<!-- component -->
<!-- post card -->



<!-- ################################################################  ---------- ############################################################-->
<!-- ################################################################  Discuss starts ############################################################-->
<!-- ################################################################  ----------- ############################################################-->






<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
<div class="w-full">
<div x-data="{ open1: false, open2: false }">
  <!-- <div class="h-screen bg-gray-100 " > -->
      <div class="sm:ml-0 md:ml-20 lg: xl:ml-20 2xl:ml-20 space-x-2">



<br>
<div style=" overflow-y: auto; height: 75vh;">



<div id="posts-list-container">
  

<% for(post of posts.reverse()){ %>
  <div id="post-<%= post._id %>">
        <div class=" bg-gray-200 shadow-lg rounded-lg  md:max-w-2xl ">
            <div class="flex items-start px-4 py-6">
               <img class="w-12 h-12 rounded-full object-cover mr-4 shadow" src="<%=post.userid.dp%>" alt="avatar">
               <div class="">
                  <div class="flex items-center justify-between">
                   <a href="/profilepage/<%=post.userid.username%>">  <h2 class="text-lg font-semibold text-gray-900 -mt-1"><%=post.userid.username%> </h2></a>
                    <a class="report-button" data-reports="<%= post.report.length %>" href="/Reporthandler/?id=<%= post.id %>&type=post"> <small class="text-sm text-red-600"><%= post.report.length %> Report</small></a>
                  </div>
                  <p class="mt-3 text-gray-700 text-sm">
                    <%=post.postBody%>
                  </p>
                  
                  <div class="mt-4 flex items-center">
                    <%if(locals.user) {%>
                      
                    <a class="toggle-like-button" data-likes="<%= post.likes.length %>" href="/Likehandler/?id=<%= post.id %>&type=post">
                     <!-- <div class="flex mr-2 text-gray-700 text-sm mr-3">
                        <svg fill="none" viewBox="0 0 24 24"  class="w-4 h-4 mr-1" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                         </svg>
                        <span><%=post.likes.length%></span>
                     </div> --> <%=post.likes.length%> likes
                    </a>
                    <%}%>
                     <div class="flex mr-2 text-gray-700 text-sm mr-8">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 mr-1" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/>
                        </svg>
                        <span><%=post.comments.length%></span>
                     </div>
                     <%if((locals.user) && locals.user.UserType=='Admin' || post.userid.id==locals.user.id || (post.report.length>=5 && locals.user.UserType=='EventsLead')   ){%>
                     <a class="delete-post-button" href="/destroypost/<%= post._id %>">
                     <div class="flex mr-2 text-gray-700 text-sm mr-4">
                      
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M6.707 4.879A3 3 0 018.828 4H15a3 3 0 013 3v6a3 3 0 01-3 3H8.828a3 3 0 01-2.12-.879l-4.415-4.414a1 1 0 010-1.414l4.414-4.414zm4 2.414a1 1 0 00-1.414 1.414L10.586 10l-1.293 1.293a1 1 0 101.414 1.414L12 11.414l1.293 1.293a1 1 0 001.414-1.414L13.414 10l1.293-1.293a1 1 0 00-1.414-1.414L12 8.586l-1.293-1.293z" clip-rule="evenodd" />
                        </svg>
                        <span>Delete</span>
                     </div>
                    </a>
                    <%}%>
                  </div>
               </div>
            </div>
         </div>
         <br>
         <div class="post-comments">

         <div class="post-comments-list">
          <div id="post-comments-<%= post._id %>">
          
         <% for(comment of post.comments){ %>
          <div id="comment-<%= comment._id %>">
        <div class=" items-center justify-center space-x-2 px-20">
          <div class="block">
            <!-- Subcomment Sample -->
            <div class="flex items-center space-x-2 space-y-2"  >
              <div class="group relative flex flex-shrink-0 self-start cursor-pointer pt-2">
          <img 
           src="<%=comment.userid.dp%>" alt="" class="h-8 w-8 object-fill rounded-full">
        </div>
              <div class="flex items-center justify-center space-x-2">
                <div class="block">
                  <div class="bg-gray-100 w-auto rounded-xl px-2 pb-2">
                    <div class="font-medium">
                      <a href="/profilepage/<%=comment.userid.username%>" class="hover:underline text-sm">
                        <small><%=comment.userid.username%></small>
                      </a>
                    </div>
                    <div class="text-xs">
                      <%=comment.commentBody%>
                    </div>
                  </div>
                  <div class="flex justify-start items-center text-xs w-full">
                    <div class="font-semibold text-gray-700 px-2 flex items-center justify-center space-x-1">
                      <%if(locals.user) {%>
                      <a class="toggle-like-button hover:underline" data-likes="<%= comment.likes.length %>" href="/Likehandler/?id=<%= comment.id %>&type=comment"  >
                        <%=comment.likes.length%> likes
                      </a>
                      <%}%>  
                                           
                      <%if((locals.user) && locals.user.UserType=='Admin' || comment.userid.id==locals.user.id || (comment.report.length>=5 && locals.user.UserType=='EventsLead')){%>
                    <small class="self-center">.</small>
                      <a href="/destroycomment/<%= comment.id %>" class="delete-comment-button">
                        <small>Delete</small>
                      </a>
                      <%}%>
                    <small class="self-center">.</small>
                        <a class="report-button" data-reports="<%= comment.report.length %>" href="/Reporthandler/?id=<%= comment.id %>&type=comment"><small class="text-red-700"><%= comment.report.length %> Report</small></a>
                     
                    </div>
                  </div>
                </div>
                <!-- component -->
              </div>
            </div>
            <!-- New Subcomment Paste Here !! -->
          </div>
        </div>
      </div>
        <%}%>
      </div>
    </div>

        <br>
        <div class="">
        <form id="post-<%= post._id %>-comments-form" action="/commentit" method="POST">
          <input name="commentBody" placeholder="Comment here" class="bg-gray-300 w-auto rounded-xl px-2 p-2">
          <input name="postid" type="hidden" value="<%=post._id%>"> 
          <button class="bg-green-200 rounded-xl p-2" type="submit" id="send-message">Post</button>
        </form>
      </div>
    </div>

      <br>
      </div>
      <%}%>
    </div>
      </div>
      <!-- New Comment Paste Here -->

      <!-- <div>
        <form action="/postit" method="POST" id="new-post-form">
          <input name="postBody" placeholder="Post here" class="bg-gray-300 w-auto rounded-xl px-2 p-2">
          <button class="bg-green-200 rounded-xl p-2" type="submit" id="send-message">Post</button>
        </form>
      </div> -->


</div>
    
<form action="/postit" method="POST" id="new-post-form">
  <div style="  position: fixed;
bottom: 0;
width: 100%;" >
<div id="chat-message-input-container" class="m-4 flex">
<input name="postBody" class="w-full bg-gray-300 rounded-l-lg p-4 border-t mr-0 border-b border-gray-400 border-l text-gray-800 border-gray-200 bg-white" placeholder="Type post content here">
<button type="submit" id="send-message"  class="bg-green-200 px-8 rounded-r-lg bg-yellow-400  text-gray-800 font-bold p-4 uppercase border-yellow-500 border-t border-b border-r" >Post</button>
</div>

</div>
</form>
    
  </div>
</div>
</div>


</div>

  <!-- component -->
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.js" defer></script>

<script src='/js/Noty.js' ></script>

<script src= "<%=assetPath('/js/comment.js')%>"></script>
<script src="<%=assetPath('/js/posts.js')%>" ></script>


<!-- <script src="js/toggle_likes.js"></script> -->
<script>

// CHANGE :: create a class to toggle likes when a link is clicked, using AJAX
class ToggleLike{
    constructor(toggleElement){
        this.toggler = toggleElement;
        this.toggleLike();
    }


    toggleLike(){
        $(this.toggler).click(function(e){
            e.preventDefault();
            let self = this;
            
            // this is a new way of writing ajax which you might've studied, it looks like the same as promises
            $.ajax({
                type: 'POST',
                url: $(self).attr('href'),
            })
            .done(function(data) {
                let likesCount = parseInt($(self).attr('data-likes'));
                console.log(likesCount);
                if (data.data.deleted == true){
                    likesCount -= 1;
                    
                }else{
                    likesCount += 1;
                }

                console.log(data)

                $(self).attr('data-likes', likesCount);
                
                $(self).html(`${likesCount} likes`);

                if(data.data.deleted==false && notifier.notifieruser!=data.data.likeableowner)
                {
                let linktonoti = '/Discuss/#'+data.data.likeabletype+'-'+data.data.likeable
                notifier.notify(data.data.likeableowner,'liked your ' + data.data.likeabletype,linktonoti)
                }

            })
            .fail(function(errData) {
                console.log('Error aaya');
            });
            

        });
    }
}

</script>
<script>
    $('.toggle-like-button').each(function(){
        let self = this;
        console.log('Like class loaded')
        let toggleLike = new ToggleLike(self);
    });
</script>








<script>


  class ToggleReport{
      constructor(toggleElement){
          this.toggler = toggleElement;
          this.toggleReport();
      }
  
  
      toggleReport(){
          $(this.toggler).click(function(e){
              e.preventDefault();
              let self = this;
              
              $.ajax({
                  type: 'POST',
                  url: $(self).attr('href'),
              })
              .done(function(data) {
                  let reportCount = parseInt($(self).attr('data-reports'));
                  console.log(reportCount);
                  if (data.data.deleted == true){
                      reportCount -= 1;
                      
                  }else{
                      reportCount += 1;
                  }
  
                  // console.log('mai hun'+data.data.reportCount)
  
                  $(self).attr('data-reports', reportCount);
                  
                  $(self).html(`${reportCount} reports`);

                  if(reportCount==5)
                  {
                    console.log('yo man')
                    let reporttonoti = '/Discuss/#'+data.data.reportabletype+'-'+data.data.reportable

                    notifier.notify('reportnoti','One ' + data.data.reportabletype +' has 5 reports',reporttonoti)
                  }
  
                  if(data.data.deleted==false && notifier.notifieruser!=data.data.reportableowner)
                  {
                  let reporttonoti = '/Discuss/#'+data.data.reportabletype+'-'+data.data.reportable
                  notifier.notify(data.data.reportableowner,'reported your ' + data.data.reportabletype,reporttonoti)
                  }
  
              })
              .fail(function(errData) {
                  console.log('Error aaya');
              });
              
  
          });
      }
  }
  
  </script>
  <script>
      $('.report-button').each(function(){
          let self = this;
          let toggleReport = new ToggleReport(self);
      });
  </script>
  


<!-- </div> -->



</body>
</html>

